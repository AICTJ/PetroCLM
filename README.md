<p align="center">
    <br>
    <img src="assets/PetroCLM.png?raw=true" width="500" height="150"/>
    <br>
</p>



# PetroCLM 石油领域语言模型

<h2 id="1">1. 项目背景</h2>
随着深度学习技术的快速发展，如ChatGPT等生成式大语言模型异军突起，其智能对话、语义理解、内容生成等诸多方面的优异表现，给自然语言处理领域带来了全新的技术变革。作为知识密集型产业，石油行业的数据具有明显的领域特征，本项目结合石油领域知识、数据及应用特征，构建并训练<b>石油垂直领域语言模型PetroCLM</b>。

本项目发布了基于石油领域知识的**石油领域语言模型PetroCLM**。为了提高垂直领域知识能力，本项目做了如下工作：

<b>（1）使用通用语料+石油领域语料对PetroCLM进行训练，为保证模型在石油领域知识的准确性，本项目采用从0到1的训练方式，提高模型对石油领域知识的理解能力；</b>

<b>（2）使用带有场景功能的指令数据集对第一步的底座模型微调，提高语言模型对场景指令的理解</b>。

**本项目的主要特点如下：**

- 围绕石油天然气领域，采用<通用语料+石油领域语料>对PetroCLM重新进行预训练，以保证石油领域知识的专业性及准确性，提高石油领域知识理解能力和模型的知识储备。
- 构建了**领域提示词工程**（Petro-CTW）数据集，通过对原始语料进行处理，提高指令准确度。
- 构建了**领域问答数据**（Petro-QA）数据集，强化领域问题理解，提高模型对于人类指令的理解。
- 构建了**数据提取算法**，提取石油专业工程文本中的关键信息，并使用这些关键信息构造语料，将普通文本转换成具有特征指令的数据集。
- 构建了**人机指令系统**，CTW任务构建了一个指令提示系统，用于快速构建Prompt。

**模型列表：**

| 类别     | 模型名称          | 模型大小 | 备注     |
| -------- | ----------------- | -------- | -------- |
| 基础模型 | PetroCLM-Ari-Base | 4B       | 底座模型 |
| 功能模型 | PetroCLM-Ari-CTW  | 4B       | 写作模型 |
| 基础模型 | PetroCLM-Tau-Base | 7B       | 底座模型 |
| 功能模型 | PetroCLM-Tau-CTW  | 7B       | 写作模型 |
| 功能模型 | PetroCLM-Tau-QA   | 7B       | 问答模型 |
| 基础模型 | PetroCLM-Gem-Base | 11B      | 训练中   |
| 功能模型 | PetroCLM-Gem-CTW  | 11B      | 训练中   |
| 功能模型 | PetroCLM-Gem-QA   | 11B      | 训练中   |

**微调数据集列表：**

| 指令类型                            | 数量    | 下载地址 | 说明                                |
| ----------------------------------- | ------- | -------- | ----------------------------------- |
| PetroCLM-CTW (写作指令数据，中文)   | 311,826 | 暂不提供 | 基于行业文档处理                    |
| PetroCLM-QA    (问答指令数据，中文) | 524,101 | 即将发布 | 部分问题来自于语言模型Self-Instruct |

**数据来源说明：**

1. 底座模型的基础数据来源于`知乎` `WuDao` `Wiki` `万卷`等；
2. 底座模型的专业数据来源于脱敏后石油行业工程文件;
3. 写作指令数据集通过自研第五维度算法整理生成；

**底座模型数据占比情况：**

| Dataset      | Type                   | Language | Percent |
| ------------ | ---------------------- | -------- | ------- |
| 石油工程文本 | Petro Engineering Text | CN&EN    | 12.96%  |
| 石油工程问答 | Petro QA               | CN       | 3.60%   |
| 新闻         | News                   | CN       | 14.40%  |
| 维基百科     | Wiki                   | CN&EN    | 0.86%   |
| 知乎文本     | Zhihu                  | CN       | 1.22%   |
| 万卷         | Wanjuan                | CN       | 39.60%  |
| 悟道         | Wudao                  | CN       | 19.44%  |
| 书籍         | Books                  | CN&EN    | 7.92%   |

## 📍 PetroCLM

<p align="center">
    <br>
    <img src="assets/CLM_Structure.png?raw=true" width="920" height="500"/>
    <br>
</p>

1.**PETRO-CTW**： 石油领域文本生成任务，可以根据提示词、标题等指令，完成领域文本生成。
2.**PETRO-NER**：石油领域实体抽取任务，可以完成对领域数据的关键信息抽取任务。
3.**PETRO-QA**：QA石油领域问答任务，可以完成石油工程领域问答功能。

<h2 id="2">2. 模型效果</h2>

<h3 id="2-1">2.1 预训练效果</h3>

- **提示词：北京市属于**
```
北京市属于半干旱、半湿润季风型大陆性气候，夏季高温多雨，冬季寒冷干燥，四季分明。年平均气温12°C，年平均降水量682毫米，年平均日照时数2766小时，年平均风速3.0m/s。该区地下水埋藏较浅，多为潜水，由表层向下依次为浅淡水、淡水中性、中性、偏弱碱水和淡水土层。地下水位年变化幅度1.5m左右，冬季出水，夏季干涸，地下水对混凝土具微腐蚀性，对混凝土结构中钢筋具微腐蚀性。
```
- **提示词：计量系统**
```
计量系统设计
供货商配套提供计量柜(内含：1面计量柜、1面辅操台及1套计量系统PLC控制器)，计量柜外形尺寸1200x800x2100(mm)，外表面涂漆面漆应色泽均匀、光亮、无锈斑，手感光滑，触摸无凹凸感。计量柜主要指标：柜体钢板厚度：1.0mm+1.0mm，面板材质为镀锌钢板。计量柜内所有电缆均为出地面，进线口全部位于外墙。
计量柜内安装流量计、分析仪及仪表管阀件，并在仪表管阀件侧用管槽及电缆槽体装配一个汇线箱，用于电缆、管线敷设。管线及管底接线端子处均有防爆护管，所有汇线箱防爆等级不低于ExdIIBT4，防护等级不低于IP55，接线箱由厂家配带。流量计电缆和管线焊接及与流量计、供电回路接线均由供货商完成。
```

<h3 id="2-2">2.2 基于提示词的领域文档生成效果</h3>
得益于第五维度算法对于语料的扩充和模型的强化训练，模型能够通过关键词提示，生成领域相关内容。

- **提示词：容器布置与安装，管道布置，往复泵布置与安装**
 ```
##容器布置与安装
1)卧式容器采用单排布置。
2)立式容器采用双排布置,应满足技术要求和设备检修的要求。
3)塔器、立式容器裙座支撑的换热器地脚螺栓均设置接地母排,保证其稳定性。
4)管廊下油气管道布置在管廊带上,在平面上与管廊带之间留有18m的安全距离。
##管道布置
1)管道布置必须符合P&ID的要求。
2)管道布置应考虑操作、安装及维修方便。
3)管道应尽可能架空或地上敷设,如确有需要可埋地或管沟敷设。
4)管道布置不得妨碍设备及其内部构件的安装和检修,不应影响消防车辆的通行。
5)管道系统应有正确可靠的支承,保证管道正确就位与正常运行。
6)管道布置应满足管道抗震要求。
7)管道系统应有一定的柔性,对机泵和设备管嘴的作用力和力矩不得超过允许值。
8)除了必要的法兰、螺纹连接外,管道连接应尽可能采用焊接。
9)有隔热层的管道在支承处应设管托。
10)在确定管道进出装置的敷设方式、方位及标高时,应做到内外协调。
##往复泵布置与安装
1)往复泵宜布置在下游。
2)泵入口过滤器尽量靠近泵入口。
3)泵入口过滤器按选用型号和产品安装要求正确安装,并留足装拆过滤网的空间。
4)泵入口过滤器按选用型号和产品安装要求正确安装,并留足装拆过滤网的空间。
5)对于需要变频的设备电机应采用变频电机(具体见GB/T25127.1-2013),电机变频范围0Hz～50Hz。
 ```

<h3 id="2-3">2.3 领域知识问答效果</h3>

通过构建**领域问答数据**（Petro-QA）数据集，强化模型对于领域问题的理解。以下是3个例子为模型问答效果的展示。
- **油罐防腐保温应包括的内容？**
 ```
油罐防腐保温应包括以下内容：
1.  针对地上/地下、保温/非保温、不同部位内外表面分别提出油罐防腐保温要求；
2.  说明油罐防腐保温的选用原则；
3.  说明油罐的保温方式、保温材料、保温层厚度及结构形式；
4.  说明油罐的内、外防腐要求，防腐涂料性能及防腐层结构；
5.  根据油罐的规模及工程需要，确定油罐是否需要阴极保护，如果需要应进行油罐阴极保护设计。
 ```
  - **采暖阀选用应满足什么条件？**

 ```
采暖阀门选用应满足以下条件： a)选用丝扣球阀或球阀，型号应满足GB12237的制造要求； b)选用闸阀，型号应满足GB12234的制造要求； c)选用循环水泵、补水泵进口的止回阀和出口的止回阀，型号应为H44H-16C和J41H-16C； d)选用燃气管道采用法兰球阀，型号Q41H-16C，球阀应满足GB12237制造要求； e)选用室外阀井、入户井的截止阀J41H-16C，放水阀、排气阀等采用截止阀J11H-16C。
 ```
   - **压力仪表安装应满足什么要求？**

 ```
压力仪表的安装应满足以下要求：
a)除输油泵、调节阀等震动较大的设备进出口位置安装的就地仪表选用耐震型，其他位置不宜选用耐震仪表。
b)差压变送器宜配五阀组，并随仪表配套提供，由厂家提供连接附件等。
c)压力变送器是否利用引压管安装，应根据是否有振动及安装高度确定。
d)压力变送器引压管、仪表阀、液位计保温伴热，应根据所在站场工艺管道的保温情况整体考虑。
e)压力仪表根部阀应采用焊接连接，根部阀为一体化延长焊接端形式。
 ```
<h3 id="2-4">2.4 领域工程设计文档的写作效果</h3>

> 下面选取了2个例子，分别验证了模型通过指令要求，对石油领域工程设计文件资料的生成能力，分别是工程设计说明书写作、技术规格书写作。

**设计说明写作**

- **请帮我写一篇通信设计说明书，要有工业电视监控系统、话音通信系统、周界报警系统的设计内容**

```
##工业电视监控系统
本工程在清管站、远控截断阀室等无人站场设视频监控点,根据《*****安全防范标准》的总体建设目标和相关规范要求,并结合本工程的实际情况(主要是新建工艺站场围栏结构、地形地貌和气象条件综合考虑),本工程在清管站、远控截断阀室等无人值守站场设置IP高清摄像前端(1080P),同时各站场视频信号通过光传输系统上传至所属控制中心进行集中存储和管理。
本工程各站场的工业电视监控系统由工业电视监视系统、周界入侵报警系统和可视对讲系统组成。
##话音通信系统
本工程在各新建有人值守站场新建***设备一套,利用<******>站及<*******>已建软交换核心设备,在<*******>设置一定数量的综合业务接入网关。
本工程各新建站场内电话用户采用***方式与地方消防部门协商解决,本次设计仅预留用户接口。
##周界报警系统
本工程在各新建站场围墙四周设置振动电缆,用于站场周界入侵检测。振动电缆安装在围墙上部,沿围栏敷设振动电缆上方铺红砖,其顶部距离为100mm;其余技术要求参见电信专用房屋设计规范(YD/T5032-2005)。振动电缆安装在围墙上方的,由防爆区划分主机、电源箱、防雷器,接线箱等设备安装于机柜上部(需与工业电视系统联动);室外部分无需供电,抗电磁干扰,抗腐蚀,能在恶劣的环境下工作,特别适用于易爆环境;具备信号识别分析功能,灵敏度高,误报率低;主要缺点是振动光纤需安装在围栏上,对围栏的质量和抗风性有较高的要求,在风速大时误报率极低,光纤损坏后需要专业工具进行修复和更换。
各有人值守站场的振动光缆一般设置在橇装化小屋内,由于橇装化小屋内设备未设置固定机架,因此可仅考虑每台设备配套1套独立红外波导通和1套紧凑型振动光纤周界报警系统。通过集中监视、控制,确保施工安全。当振动电缆检测到振动信号时,系统发出声光报警并记录,提醒值班人员注意。
本工程在各新建站场大门处设置激光对射探测器,通过信号电缆将报警信号发送至振动光缆周界报警主机,实现与工业电视系统的联动。
```

**设计规格写作**

- **请帮我写一篇自控系统部分技术规格书，要有设计原则、主要功能、SCADA系统扩容等**

```
##设计原则
系统应是在连续运行的系统中、下游工艺设备安全地与生产过程连接的基础上。
系统的配置应与整个工厂自控系统相匹配,并应符合下列规定:
1)当装置出现紧急情况时,操作人员将关闭进厂紧急截断阀;
2)当各紧急截断阀上游或下游管线发生泄漏事故时,由ESD对全厂进行泄压,手动打开放空阀进行放空。
##系统主要功能
1)自动采集各类模拟量数据,实时进行数据采集、运算和处理等;
2)完成变配电所电气设备(包括断路器、隔离开关、接地开关、互感器等)的监控和联锁保护;
3)实现对变电所的远程监视和控制;
4)通过RS485接口将采集到的数据上传至中央控制室DCS系统,通信协议采用ModbusRTU;5)向中央控制室SCADA系统传送本站的重要生产数据,传输协议采用TCP/IP;
6)向SCADA中心传送本站的重要生产数据,传输协议采用TCP/IP。
7)为保证设备安全和系统的可靠,所有仪表信号传输接口要求均采用RJ45。
8)现场仪表至防爆接线箱的电缆敷设及接线均由供货商负责完成,防爆接线箱配套提供防爆格兰头。
##SCADA系统扩容
本工程新增SCADA系统组态调试工作量约为*×*m*。已建SCADA系统相关点数为均不满足本次扩容需求,本次仅需增加硬件组态、软件调试等工作费用。
```


<h2 id="3">3. 训练细节</h2>

<h3 id="3-1">3.1 预训练数据集构建</h3>

我们搜集了互联网上的若干开源中英文语料，主要由百度百科、悟道、万卷和维基百科等文本构成。

对通用部分的数据集，我们剔除了数据集中有害的内容及重复的数据。

专业领域的数据，由本行业的专业文档脱敏转换而成，并加入了行业规范、各种公告、法律法规等文本。

<h3 id="3-2">3.2 预训练训练过程</h3>

在训练之前，我们构造了一套完整的数据预处理工具，并设计了按照文章段落结构进行解析的算法，将文档拆分成树形结构数据集，尽量将整段文本生成一个样本，对于超长的段落，采用句式分析算法，拆分成具有完整逻辑语义的句子列表，在保证语义连续性、完整性的前提下，分割的段数尽可能少，每个样本的长度尽可能长。

预训练过程我们使用了transformers的trainer搭配Deepspeed ZeRO2进行多机多卡训练

<h3 id="3-3">3.3 指令微调数据集构建</h3>

微调数据集主要有两个方面：

**通用指令数据** 
在预训练数据集中，整理开源数据中具有问答特征的数据，根据特征识别算法，进行去重、去害过滤。对于回答过于简短或不具有参考价值的回答，则将问题输入给其它语言模型进行重新回答，以形成通用指令集。

**专业指令数据** 
我们开发了第五维度算法，并结合文章段落结构拆分算法，构造出段落中心语义的逻辑表示，并于原始文本配对，形成专业文本指令数据。同时我们在专业网站及各种本行业的论坛爬取专业领域的问答记录，加以分析，去除错误的和重复的记录，整理成行业问答数据。


<h3 id="3-4">3.4 指令微调训练过程</h3>

当前版本的模型采用全量微调的方式。

<h2 id="4">4. 局限性</h2>

由于时间成本、硬件成本和技术上的原因，我们的模型存在局限性，包括但不限于：

- 本模型是应用于特定行业领域特定场景的专用模型，不具备大语言模型的通用能力，对于非行业应用，效果存在明显差距；
- 受条件和时间限制，本模型的预训练不够充分；
- 模型目前任务指令遵循能力有限；
- 尽管我们在减少模型幻觉方面做了很多工作，但是有些情况仍会出现不正确的幻觉输出；
- ······

<h2 id="5">5. 未来计划</h2>

- 增加算力资源，进一步训练底座模型；
- 优化指令算法，增加第五维度抽取的关键信息的能力，提高指令数据集的质量；
- ······

<h2 id="6">6. 其他</h2>

<h3 id="6-1">6.1 贡献者（排名不分先后）</h3>

基础模型：Robin, xxWeiDG, Xinqiang Feng

基础数据：Peter Jiang, Misty Liu, Yori Wang

指令数据与训练：Aurora Bi, Ze Gan

工具与数据增强：Albert, Big Liu

测试与演示代码及用例：Pike Liu, Hunter Shen, Zed

<h3 id="6-2">6.2 引用</h3>

如果你使用到了我们的仓库，请引用下列相关论文：

```bibtex
@misc{PetroCLM,
  author = {Peter Jiang, Robin, xxWeiDG, Xinqiang Feng,  
  Misty Liu,Yori Wang, Amy Bi, Ze Gan, Albert, Big Liu, 
  Pike Liu，Hunter Shen, Zed},
  title = {PetroCLM},
  year = {2023},
 url = {https://github.com/AICTJ/PetroCLM},
}
```

<h3 id="6-3">6.3 致谢</h3>

我们非常感谢以下这些开源项目给予我们的帮助：

- [ChatGLM](https://github.com/THUDM/ChatGLM-6B)
- [Chinese-LLaMA-Alpaca](https://github.com/ymcui/Chinese-LLaMA-Alpaca)
- [GLM](https://github.com/THUDM/GLM)
- [LLaMA-factory](https://github.com/hiyouga/LLaMA-Factory)
- ······
